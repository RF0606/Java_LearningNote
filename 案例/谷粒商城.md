谷粒商城基础篇

## 1. 项目介绍

### 1.1 电商模式

市面上有5种常见的电商模式 B2B、B2C、C2B、C2C、O2O



B2B(Business to Business)，是指商家和商家建立的商业关系，如阿里巴巴



B2C(Business to Consumer) 就是我们经常看到的供应商直接把商品买个 用户，即 “商对客” 模式，也就是我们呢说的商业零售，直接面向消费销 售产品和服务，如苏宁易购，京东，天猫，小米商城



C2B (Customer to Business),即消费者对企业，先有消费者需求产生 而后有企业生产，即先有消费者提出需求，后又生产企业按需求组织生产



C2C (Customer to Consumer) 客户之间把自己的东西放到网上去卖 。 如淘宝、咸鱼



O2O 即 Online To Offline，也即将线下商务的机会与互联网 结合在一起，让互联网成为线上交易前台，线上快速支付，线上优质服务， 如：饿了么，美团，淘票票，京东到家

### 1.2 谷粒商城

谷粒商城是一个B2C模式的电商平台，销售自营商品给客户

## 2. 项目建构图

![在这里插入图片描述](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3VuaXF1ZV9wZXJmZWN0,size_16,color_FFFFFF,t_70.png)

前后分离开发，分为内网部署和外网部署，外网是面向公众访问的。访问前端项目，可以有手机APP，电脑网页；内网部署的是后端集群，前端在页面上操作发送请求到后端，在这途中会经过Nginx集群，Nginx把请求转交给API网关(springcloud gateway)（网关可以根据当前请求动态地路由到指定的服务，看当前请求是想调用商品服务还是购物车服务还是检索服务），从路由过来如果请求很多，可以负载均衡地调用商品服务器中一台（商品服务复制了多份），当商品服务器出现问题也可以在网关层面对服务进行熔断或降级（使用阿里的sentinel组件），网关还有其他的功能如认证授权、限流（只放行部分到服务器）等。

到达服务器后进行处理（springboot为微服务），服务与服务可能会相互调用（使用feign组件），有些请求可能经过登录才能进行（基于OAuth2.0的认证中心。安全和权限使用springSecurity控制）

服务可能保存了一些数据或者需要使用缓存，我们使用redis集群（分片+哨兵集群）。持久化使用mysql，读写分离和分库分表。

服务和服务之间会使用消息队列（RabbitMQ），来完成异步解耦，分布式事务的一致性。有些服务可能需要全文检索，检索商品信息，使用ElaticSearch。

服务可能需要存取数据，使用阿里云的对象存储服务OSS。

项目上线后为了快速定位问题，使用ELK对日志进行处理，使用LogStash收集业务里的各种日志，把日志存储到ES中，用Kibana可视化页面从ES中检索出相关信息，帮助我们快速定位问题所在。

在分布式系统中，由于我们每个服务都可能部署在很多台机器，服务和服务可能相互调用，就得知道彼此都在哪里，所以需要将所有服务都注册到注册中心。服务从注册中心发现其他服务所在位置（使用阿里Nacos作为注册中心）。

每个服务的配置众多，为了实现改一处配置相同配置就同步更改，就需要配置中心，也使用阿里的Nacos，服务从配置中心中动态取配置。

服务追踪，追踪服务调用链哪里出现问题，使用springcloud提供的Sleuth、Zipkin、Metrics，把每个服务的信息交给开源的Prometheus进行聚合分析，再由Grafana进行可视化展示，提供Prometheus提供的AlterManager实时得到服务的警告信息，以短信/邮件的方式告知服务开发人员。

还提供了持续集成和持续部署。项目发布起来后，因为微服务众多，每一个都打包部署到服务器太麻烦，有了持续集成后开发人员可以将修改后的代码提交到github，运维人员可以通过自动化工具Jenkins Pipeline将github中获取的代码打包成docker镜像，最终是由k8s集成docker服务，将服务以docker容器的方式运行。

![在这里插入图片描述](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//watermark,type_ZmFuZ3poZW5naGVpdGk,shadow_10,text_aHR0cHM6Ly9ibG9nLmNzZG4ubmV0L3VuaXF1ZV9wZXJmZWN0,size_16,color_FFFFFF,t_70-16502908418622.png)

反映了需要创建的微服务以及相关技术。

前后分离开发。前端项目分为admin-vue（工作人员使用的后台管理系统）、
shop-vue（面向公众访问的web网站）、app（公众）、小程序（公众）

商品服务：商品的增删改查、商品的上下架、商品详情
支付服务
优惠服务
用户服务：用户的个人中心、收货地址
仓储服务：商品的库存
秒杀服务
订单服务：订单增删改查
检索服务：商品的检索ES
中央认证服务：登录、注册、单点登录、社交登录
购物车服务
后台管理系统：添加优惠信息等

**项目技术&特色**

前后分离开发，并开发基于vue的后台管理系统 SpringCloud全新的解决方案 应用监控、限流、网关、熔断降级等分布式方案，全方位涉及 透彻讲解分布式事务，分布式锁等分布式系统的难点 压力测试与性能优化 各种集群技术的区别以及使用 CI/CD 使用

## 3. 环境

### 3.1 linux服务器安装jdk1.8

```bash
# 下载并解压jdk1.8
tar -zxvf jdk-8u281-linux-x64.tar.gz(检查本机有没有jdk有的话卸载掉。安装上自己的jdk)

# 配上环境变量
vim /etc/profile
# 添加一下两行代码
export JAVA_HOME=jdk的位置
export PATH=$PATH:$JAVA_HOME/bin

# 使配置生效
source  /etc/profile
```

### 3.2 linux服务器安装docker

```bash
# 卸载docker旧版本
yum remove docker \
                  docker-client \
                  docker-client-latest \
                  docker-common \
                  docker-latest \
                  docker-latest-logrotate \
                  docker-logrotate \
                  docker-engine
                  
# 安装docker环境
yum install -y yum-utils
# 配置阿里云镜像
yum-config-manager --add-repo http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo
# 安装Docker CE
yum -y install docker-ce docker-ce-cli containerd.io
# 启动docker
systemctl start docker
# 阿里云镜像加速
sudo mkdir -p /etc/docker
sudo tee /etc/docker/daemon.json <<-'EOF'
{
  "registry-mirrors": ["https://vf58ggq6.mirror.aliyuncs.com"]
}
EOF
sudo systemctl daemon-reload
sudo systemctl restart docker
```

### 3.3 linux服务器安装mysql

```bash
# 拉取mysql镜像到本地
docker pull mysql

# 启动mysql服务运行容器
docker run -p 3306:3306 --name mysql 
-v /mydata/mysql/log:/var/log/mysql
-v /mydata/mysql/data:/var/lib/mysql
-v /mydata/mysql/conf:/etc/mysql/conf.d
-v /mydata/mysql/mysql-files:/var/lib/mysql-files/ 
-e MYSQL_ALLOW_EMPTY_PASSWORD=root -d mysql

# 进入mysql容器
docker exec -it mysql bin/bash

# 登录mysql
mysql -uroot

# 修改密码
alter user 'root'@'%' IDENTIFIED BY 'Ytc19980211..';

# 配置 skip-name-resolve跳过域名解析加快访问
vi /mydata/mysql/conf/my.cnf

[client]
default-character-set=utf8

[mysql]
default-character-set=utf8

[mysqld]
init_connect='SET collation_connection = utf8_unicode_ci'
init_connect='SET NAMES utf8'
character-set-server=utf8
collation-server=utf8_unicode_ci
skip-character-set-client-handshake
skip-name-resolve

# 重启mysql
docker restart mysql
```

### 3.4 linux服务器安装redis

```bash
# 拉取redis镜像到本地
docker pull redis

# 修改需要自定义的配置(docker-redis默认没有配置文件，自己在宿主机建立后挂载映射)
mkdir -p /mydata/redis/conf
touch /mydata/redis/conf/redis.conf

vi /mydata/redis/conf/redis.conf
requirepass Ytc19980211..

# 启动redis服务运行容器
docker run -p 6379:6379 --name redis 
-v /mydata/redis/data:/data 
-v /mydata/redis/conf/redis.conf:/etc/redis/redis.conf 
-d redis redis-server /etc/redis/redis.conf

# 直接进去redis客户端
docker exec -it redis redis-cli
```

### 3.5 本地开发环境

```bash
Maven
Jdk
Idea
Webstorm
Git
```

### 3.6 创建git项目

![image-20220408231623155](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220408231623155.png)

### 3.7 idea拉项目

创建5个spring模块

![image-20220408231718748](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220408231718748.png)

```bash
商品服务gulimall-product
存储服务gulimall-ware
订单服务gulimall-order
优惠服务gulimall-coupon
用户服务gulimall-member
```

每个模块选择web

为项目种创建pom.xml并添加模块

```xml
<?xml version="1.0" encoding="UTF-8"?>
<project xmlns="http://maven.apache.org/POM/4.0.0"
         xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
         xsi:schemaLocation="http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd">
    <modelVersion>4.0.0</modelVersion>

    <groupId>com.ytc.gulimall</groupId>
    <artifactId>gulimall</artifactId>
    <version>1.0-SNAPSHOT</version>
    <name>gulimall</name>
    <description>谷粒商城-聚合服务</description>
    <modules>
        <module>gulimall-coupon</module>
        <module>gulimall-member</module>
        <module>gulimall-order</module>
        <module>gulimall-product</module>
        <module>gulimall-ware</module>
    </modules>

    <packaging>pom</packaging>

    <properties>
        <maven.compiler.source>8</maven.compiler.source>
        <maven.compiler.target>8</maven.compiler.target>
    </properties>
    
    <dependencies>
        <dependency>
            <groupId>com.baomidou</groupId>
            <artifactId>mybatis-plus-boot-starter</artifactId>
            <version>3.5.1</version>
        </dependency>
        <dependency>
            <groupId>mysql</groupId>
            <artifactId>mysql-connector-java</artifactId>
        </dependency>
        <dependency>
            <groupId>org.projectlombok</groupId>
            <artifactId>lombok</artifactId>
        </dependency>
        <dependency>
            <groupId>org.springframework.boot</groupId>
            <artifactId>spring-boot-devtools</artifactId>
        </dependency>
    </dependencies>
    
    <dependencyManagement>
        <dependencies>
            <dependency>
                <groupId>org.springframework.boot</groupId>
                <artifactId>spring-boot-dependencies</artifactId>
                <version>2.6.6</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
            <dependency>
                <groupId>org.springframework.cloud</groupId>
                <artifactId>spring-cloud-dependencies</artifactId>
                <version>2021.0.1</version>
                <type>pom</type>
                <scope>import</scope>
            </dependency>
        </dependencies>
    </dependencyManagement>
    
</project>
```

将每个模块的pom.xml修改

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.6.6</version>
    <relativePath/> <!-- lookup parent from repository -->
</parent>
<groupId>com.ytc.gulimall</groupId>

改为

<parent>
    <artifactId>gulimall</artifactId>
    <groupId>com.ytc.gulimall</groupId>
    <version>1.0-SNAPSHOT</version>
</parent>
```

修改.gitignore

```
target/
pom.xml.tag
pom.xml.releaseBackup
pom.xml.versionsBackup
pom.xml.next
release.properties
dependency-reduced-pom.xml
buildNumber.properties
.mvn/timing.properties
# https://github.com/takari/maven-wrapper#usage-without-binary-jar
.mvn/wrapper/maven-wrapper.jar

**/mvnw
**/mvnw.cmd

**/.mvn
**/target

.idea

**/.gitignore
```

### 3.8 创建数据库

```bash
gulimall_oms
gulimall_pms
gulimall_sms
gulimall_ums
gulimall_wms
```

执行资料的sql

### 3.9 人人开源

克隆renren-fast

将项目加入gulimall，给gulimall的pom.xml添加renren-fast模块

创建gulimall_admin数据库

执行renren-fast中的sql

修改数据库连接信息

运行

克隆renren-fast-vue

运行

默认账号密码admin admin

### 3.10 逆向工程

创建maven公共模块gulimall-common

导入依赖

```xml
<dependencies>
    <dependency>
        <groupId>commons-lang</groupId>
        <artifactId>commons-lang</artifactId>
        <version>2.6</version>
    </dependency>
</dependencies>
```

从renren-fast中将以下类复制过来

![image-20220409185633544](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220409185633544.png)

克隆renren-generator

将项目加入gulimall，给gulimall的pom.xml添加renren-generator模块

修改renren-generator的application.yml中需要生成代码的数据库配置

```yml
spring:
  datasource:
    type: com.alibaba.druid.pool.DruidDataSource
    #MySQL配置
    driverClassName: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://124.220.11.122:3306/gulimall_pms?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: Ytc19980211..
```

修改renren-generator的generator.properties

```properties
mainPath=com.ytc
package=com.ytc.gulimall
moduleName=product
author=Tiancheng Yang
email=214800722@qq.com
tablePrefix=pms_
```

修改controller的template，删除shiro的依赖和注解RequiresPermissions

启动renren-generator下载生成的代码，解压，将main下的代码放到目标模块中

在目标模块中添加gulimall-common依赖

配置目标模块的数据库连接

## 4. SpringCloudAlibaba简介

服务器下载nacos

```bash
# 拉取nacos/nacos-server镜像到本地
docker pull nacos/nacos-server

# 启动nacos/nacos-server服务运行容器 单机模式
docker run --name nacos -e MODE=standalone -p 8848:8848 -d nacos/nacos-server
```

### 4.1 搭建环境

在gulimall中引入依赖管理

```xml
<dependencyManagement>
    <dependencies>
        <dependency>
            <groupId>com.alibaba.cloud</groupId>
            <artifactId>spring-cloud-alibaba-dependencies</artifactId>
            <version>2021.0.1.0</version>
            <type>pom</type>
            <scope>import</scope>
        </dependency>
    </dependencies>
</dependencyManagement>
```

### 4.2 Nacos注册中心

在gulimall中引入依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
</dependency>
```

在微服务中配置端口号、服务名、nacos地址

```yml
spring:
  application:
    name: gulimall-coupon
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
server:
  port: 11100
```

在启动类上添加注解，可以不用加

```java
@EnableDiscoveryClient
```

### 4.3 OpenFeign远程调用

在gulimall中引入依赖，高版本需要导入loadbalancer依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-loadbalancer</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-openfeign</artifactId>
</dependency>
```

在Coupon模块中编写被远程调用的测试接口

```java
@RestController
@RequestMapping("coupon/coupon")
public class CouponController {
    @RequestMapping("/member/list")
    public R membercoupons() {
        CouponEntity couponEntity = new CouponEntity();
        couponEntity.setCouponName("11111");
        return R.ok().put("coupons", Arrays.asList(couponEntity));
    }
}
```

在Member模块中创建feign包编写远程调用接口服务

```java
@Service
@FeignClient("gulimall-coupon") // 服务名
public interface CouponFeignService {

    @RequestMapping("/coupon/coupon/member/list") // 从Coupon中复制过来
    public R membercoupons();
}
```

在Member模块中编写远程调用的测试接口

```java
@RestController
@RequestMapping("member/member")
public class MemberController {
    @Autowired
    CouponFeignService couponFeignService;

    @RequestMapping("/coupons")
    public R test() {
        MemberEntity memberEntity = new MemberEntity();
        memberEntity.setNickname("asdfasdfasdfasdf");

        R membercoupons = couponFeignService.membercoupons();

        return R.ok().put("member", memberEntity).put("coupons", membercoupons.get("coupons"));
    }
}
```

在Member启动类上添加注解，括号里可以不填

```java
@EnableFeignClients
@EnableFeignClients("com.ytc.gulimall.member.feign") // feign包
```

### 4.4 Nacos配置中心

在gulimall中引入依赖，高版本需要导入bootstrap依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alibaba-nacos-config</artifactId>
</dependency>
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-bootstrap</artifactId>
</dependency>
```

在微服务中bootstrap.yml配置nacos地址

```yml
spring:
  application:
    name: gulimall-coupon
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        file-extension: yaml # 默认是properties
```

在nacos配置中心添加配置，Data ID是 微服务名.配置格式

![image-20220410183140798](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220410183140798.png)

编写测试接口

```java
@RestController
@RequestMapping("coupon/coupon")
public class CouponController {
    @Value("${cuser.name}")
    private String name;
    @Value("${cuser.age}")
    private Integer age;

    @RequestMapping("/test")
    public R test() {
        return R.ok().put("name", name).put("age", age);
    }
}
```

在controller类上添加注解实现动态更新配置

```java
@RefreshScope
```

或者在配置中添加refresh-enabled: true

```yml
spring:
  application:
    name: gulimall-coupon
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        file-extens ion: yaml
        namespace: d74532f6-258c-44e0-a00b-3e82f7ec19d6
        group: dev
		refresh-enabled: true
```

命名空间，环境隔离，微服务隔离

![image-20220410192312607](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220410192312607.png)

配置中心里切换命名空间，添加配置

并且可以给配置文件添加分组

填写命名空间ID，分组名

```yml
spring:
  application:
    name: gulimall-coupon
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        file-extens ion: yaml
        namespace: d74532f6-258c-44e0-a00b-3e82f7ec19d6
        group: dev
```

多个配置集

```yml
spring:
  application:
    name: gulimall-coupon
  cloud:
    nacos:
      config:
        server-addr: 127.0.0.1:8848
        file-extens ion: yaml
        namespace: d74532f6-258c-44e0-a00b-3e82f7ec19d6
        group: dev
        refresh-enabled: true
        extension-configs:
          - data-id: application.yaml
            group: dev
            refresh: true
          - data-id: mybatis.yaml
            group: dev
            refresh: true
```

### 4.5 Gateway网关

创建gulimall-gateway模块

给gulimall的pom.xml添加gulimall-gateway模块

将每个模块的pom.xml修改

```xml
<parent>
    <groupId>org.springframework.boot</groupId>
    <artifactId>spring-boot-starter-parent</artifactId>
    <version>2.6.6</version>
    <relativePath/> <!-- lookup parent from repository -->
</parent>
<groupId>com.ytc.gulimall</groupId>

改为

<parent>
    <artifactId>gulimall</artifactId>
    <groupId>com.ytc.gulimall</groupId>
    <version>1.0-SNAPSHOT</version>
</parent>
```

引入依赖

```xml
<dependency>
    <groupId>org.springframework.cloud</groupId>
    <artifactId>spring-cloud-starter-gateway</artifactId>
</dependency>
```

启动类排除数据源

```java
@SpringBootApplication(exclude = {DataSourceAutoConfiguration.class})
public class GulimallGatewayApplication {

    public static void main(String[] args) {
        SpringApplication.run(GulimallGatewayApplication.class, args);
    }

}
```

配置注册中心

```yml
spring:
  application:
    name: gulimall-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
```

断言测试

```yml
spring:
  application:
    name: gulimall-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 127.0.0.1:8848
    gateway:
      routes:
        - id: baidu_route
          uri: http://www.baidu.com
          predicates:
            - Query=url,baidu
        - id: qq_route
          uri: http://www.qq.com
          predicates:
            - Query=url,qq
        - id: admin_route
          uri: lb://renren-fast # 去注册中心拉去该服务名
          predicates:  # 什么情况下路由给它
            - Path=/api/** # 默认前端项目都带上api前缀，
          filters:
            - RewritePath=/api/(?<segment>.*),/renren-fast/$\{segment} # 重新路径
server:
  port: 88
```

http://localhost:88?url=baidu

## 5. 三级分类

### 5.1 查出所有分类以及子分类

在gulimall-product的CategoryController中添加方法

```java
/**
* 查出所有分类以及子分类，以树形结构组装起来
*/
@RequestMapping("/list/tree")
public R list(){

    List<CategoryEntity> entities = categoryService.listWithTree();

    return R.ok().put("data", entities);
}
```

CategoryService中添加抽象方法

```java
List<CategoryEntity> listWithTree();
```

CategoryServiceImpl中添加方法

```java
@Override
public List<CategoryEntity> listWithTree() {
    // 1 查出所有分类
    List<CategoryEntity> entities = baseMapper.selectList(null);
    // 2 组装成父子的树形结构
    List<CategoryEntity> list = entities.stream().filter(
        categoryEntity -> categoryEntity.getParentCid() == 0
    ).map(categoryEntity -> {
        categoryEntity.setChildren(getChildren(categoryEntity, entities));
        return categoryEntity;
    }).sorted(Comparator.comparingInt(o -> (o.getSort() == null ? 0 : o.getSort()))
             ).collect(Collectors.toList());

    return list;
}

// 递归查找所有菜单的子菜单
private List<CategoryEntity> getChildren(CategoryEntity root, List<CategoryEntity> all) {
    List<CategoryEntity> list = all.stream().filter(
        categoryEntity -> categoryEntity.getParentCid().equals(root.getCatId())
    ).map(categoryEntity -> {
        // 1 找到子菜单
        categoryEntity.setChildren(getChildren(categoryEntity, all));
        return categoryEntity;
    }).sorted(
        // 2 菜单的排序
        Comparator.comparingInt(o -> (o.getSort() == null ? 0 : o.getSort()))
    ).collect(Collectors.toList());

    return list;
}
```

### 5.2 配置网关路由与路径重写

登录renren-fast-vue页面，用户密码admin

![image-20220411001639861](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220411001639861.png)

![image-20220411001757596](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220411001757596.png)

列表数据被存在了gulimall_admin的sys_menu

菜单路由对应后端controller

![image-20220411002020687](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220411002020687.png)

比如sys-role具体的视图路由组件在renren-fast-vue/views/modules/sys/role.vue

所以product/category就要在modules下创建product/category.vue

请求数据并打印在控制台测试

```vue
<template>
  <el-tree :data="data" :props="defaultProps" @node-click="handleNodeClick"></el-tree>
</template>

<script>
export default {
  name: 'category',
  data () {
    return {
      data: [],
      defaultProps: {
        children: 'children',
        label: 'label'
      }
    }
  },
  methods: {
    handleNodeClick (data) {
      console.log(data)
    },
    getMenus () {
      this.$http({
        url: this.$http.adornUrl('/product/category/list/tree'),
        method: 'get'
      }).then(data => {
        console.log(data.data.data)
      })
    }
  },
  activated () {
    this.getMenus()
  }
}
</script>

<style scoped>

</style>
```

修改前段请求的baseUrl

在renren-fast-vue/static/config/index.js为网关88端口

```js
window.SITE_CONFIG['baseUrl'] = 'http://localhost:88/api'
```

此时前段无法登录，由于原来是请求8080/renren-fast后端的，现在请求了88，所以网关要默认转发到8080/renren-fast

在renren-fast中引入nacos注册中心依赖

```xml
<dependency>
   <groupId>com.alibaba.cloud</groupId>
   <artifactId>spring-cloud-starter-alibaba-nacos-discovery</artifactId>
   <version>2.2.6.RELEASE</version>
</dependency>
```

配置

```yml
spring:
  application:
    name: renren-fast
  cloud:
    nacos:
      discovery:
        server-addr: 124.220.11.122:8848
```

修改gulimall-gateway配置

```yml
spring:
  application:
    name: gulimall-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 124.220.11.122:8848
    gateway:
      routes:
        - id: admin_route
          uri: lb://renren-fast
          predicates: # 什么情况下路由给它
            - Path=/api/** # 默认前端项目都带上api前缀，
          filters:
            - RewritePath=/api/(?<segment>.*),/renren-fast/$\{segment} # 重新路径
server:
  port: 88
```

再次测试但是出现跨域问题

方式一使用Nginx反向代理转发请求

方式二网关添加响应头

在gulimall-gateway中创建Cors配置类

```java
package com.ytc.gulimall.gateway.config;

import org.springframework.context.annotation.Bean;
import org.springframework.context.annotation.Configuration;
import org.springframework.web.cors.CorsConfiguration;
import org.springframework.web.cors.reactive.CorsWebFilter;
import org.springframework.web.cors.reactive.UrlBasedCorsConfigurationSource;

@Configuration
public class CorsConfig {

    @Bean
    public CorsWebFilter corsWebFilter() {
        UrlBasedCorsConfigurationSource source = new UrlBasedCorsConfigurationSource();

        CorsConfiguration corsConfiguration = new CorsConfiguration();

        corsConfiguration.addAllowedHeader("*"); // 请求头
        corsConfiguration.addAllowedMethod("*"); // 请求方式
//        corsConfiguration.addAllowedOrigin("*"); // 请求来源 springboot2.4以下
        corsConfiguration.addAllowedOriginPattern("*"); // 请求来源
        corsConfiguration.setAllowCredentials(true); // 携带cookie

        source.registerCorsConfiguration("/**", corsConfiguration); // 所有路径进行跨域
        return new CorsWebFilter(source);
    }
}
```

再将renren-fast的CorsConfig里的方法注释掉

### 5.3 树形展示三级分类数据

在gulimall-gateway中配置product的路由规则

把模糊的规则放在最下面降低优先级

```yml
spring:
  application:
    name: gulimall-gateway
  cloud:
    nacos:
      discovery:
        server-addr: 124.220.11.122:8848
    gateway:
      routes:
        - id: product_route
          uri: lb://gulimall-product
          predicates:
            - Path=/api/product/**
          filters:
            - RewritePath=/api/(?<segment>.*),/$\{segment} # 重新路径
        - id: admin_route
          uri: lb://renren-fast
          predicates: # 什么情况下路由给它
            - Path=/api/** # 默认前端项目都带上api前缀，
          filters:
            - RewritePath=/api/(?<segment>.*),/renren-fast/$\{segment} # 重新路径
server:
  port: 88
```

修改vue展示数据

```vue
<template>
  <el-tree :data="menus" :props="defaultProps" @node-click="handleNodeClick"></el-tree>
</template>

<script>
export default {
  name: 'category',
  data () {
    return {
      menus: [],
      defaultProps: {
        children: 'children',
        // label: 'name',
        label (data, node) {
          return `${data.catId} ${data.name}`
        }
      }
    }
  },
  methods: {
    handleNodeClick (data) {
      console.log(data)
    },
    getMenus () {
      this.$http({
        url: this.$http.adornUrl('/product/category/list/tree'),
        method: 'get'
      }).then(({data}) => {
        console.log(data.data)
        this.menus = data.data
      })
    }
  },
  activated () {
    this.getMenus()
  }
}
</script>

<style scoped>

</style>
```

### 5.4 删除分类

添加按钮修改ui

```vue
<template>
  <el-tree :data="menus" :props="defaultProps" show-checkbox
           node-key="catId" :expand-on-click-node="false">
    <span class="custom-tree-node" slot-scope="{ node, data }">
        <span>{{ node.label }}</span>
        <span>
          <el-button
            v-if="node.level <= 2"
            type="text"
            size="mini"
            @click="append(data)">
            添加
          </el-button>
          <el-button
            v-if="node.childNodes.length === 0"
            type="text"
            size="mini"
            @click="remove(node, data)">
            删除
          </el-button>
        </span>
      </span>
  </el-tree>
</template>

<script>
export default {
  name: 'category',
  data () {
    return {
      menus: [],
      defaultProps: {
        children: 'children',
        // label: 'name',
        label (data, node) {
          // console.log(`${data.catId} ${data.name}`)
          console.log(data)
          return `${data.catId} ${data.name}`
        }
      }
    }
  },
  methods: {
    getMenus () {
      this.$http({
        url: this.$http.adornUrl('/product/category/list/tree'),
        method: 'get'
      }).then(({data}) => {
        // console.log(data.data)
        this.menus = data.data
      })
    },
    append (data) {
      console.log(data)
    },
    remove (node, data) {
      console.log(node)
      console.log(data)
    }
  },
  activated () {
    this.getMenus()
  }
}
</script>

<style scoped>
.custom-tree-node {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  padding-right: 8px;
}
</style>
```

在gulimall-product的CategoryController修改默认生成的方法

```java
/**
* 删除
*/
@RequestMapping("/delete")
public R delete(@RequestBody Long[] catIds){
//    categoryService.removeByIds(Arrays.asList(catIds));
    categoryService.removeMenusByIds(Arrays.asList(catIds));

    return R.ok();
}
```

CategoryService中添加方法

```java
void removeMenusByIds(List<Long> catIds);
```

CategoryServiceImpl中添加方法

```java
@Override
public void removeMenusByIds(List<Long> catIds) {
//   TODO 检查当前删除的菜单是否被其他地方引用

    baseMapper.deleteBatchIds(catIds);
}
```

修改为逻辑删除

修改gulimall-product配置

```yml
mybatis-plus:
  global-config:
    db-config:
      id-type: auto
      logic-delete-value: 1
      logic-not-delete-value: 0
```

在CategoryEntity实体类上添加注解，修改逻辑删除条件

```java
/**
* 是否显示[0-不显示，1显示]
*/
@TableLogic(value = "1", delval = "0")
private Integer showStatus;
```

vue添加删除方法和细节优化

```vue
<!--suppress ALL -->
<template>
  <el-tree :data="menus" :props="defaultProps" show-checkbox
           node-key="catId" :expand-on-click-node="false"
           :default-expanded-keys="expandedKey" @node-click="nodeClick">
    <span class="custom-tree-node" slot-scope="{ node, data }">
        <span>{{ node.label }}</span>
        <span>
          <el-button
            v-if="node.level <= 2"
            type="text"
            size="mini"
            @click="append(data)">
            添加
          </el-button>
          <el-button
            v-if="node.childNodes.length === 0"
            type="text"
            size="mini"
            @click="remove(node, data)">
            删除
          </el-button>
        </span>
      </span>
  </el-tree>
</template>

<script>
export default {
  name: 'category',
  data () {
    return {
      menus: [],
      expandedKey: [],
      defaultProps: {
        children: 'children',
        // label: 'name',
        label (data, node) {
          // console.log(`${data.catId} ${data.name}`)
          // console.log(data)
          return `${data.catId} ${data.name}`
        }
      }
    }
  },
  methods: {
    getMenus () {
      this.$http({
        url: this.$http.adornUrl('/product/category/list/tree'),
        method: 'get'
      }).then(({data}) => {
        // console.log(data.data)
        this.menus = data.data
      })
    },
    append (data) {
      console.log(data)
    },
    remove (node, data) {
      this.$confirm(`是否删除【${data.name}】菜单?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        let ids = [data.catId]
        this.$http({
          url: this.$http.adornUrl('/product/category/delete'),
          method: 'post',
          data: this.$http.adornData(ids, false)
        }).then(({data}) => {
          this.$message({
            type: 'success',
            message: '菜单删除成功'
          })
          // 刷新菜单
          this.getMenus()
          // 自动展开到父节点
          this.expandedKey = [node.parent.data.catId]
        })
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消删除'
        })
      })
    },
    nodeClick (a,b,c) {
      console.log()
    }
  },
  // 生命周期
  activated () {
    this.getMenus()
  }
}
</script>

<style scoped>
.custom-tree-node {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  padding-right: 8px;
}
</style>
```

### 5.5 添加分类

```vue
<!--suppress ALL -->
<template>
  <div>
    <el-tree :data="menus" :props="defaultProps" show-checkbox
             node-key="catId" :expand-on-click-node="false"
             :default-expanded-keys="expandedKey">
    <span class="custom-tree-node" slot-scope="{ node, data }">
        <span>{{ node.label }}</span>
        <span>
          <el-button
            v-if="node.level <= 2"
            type="text"
            size="mini"
            @click="append(data)">
            添加
          </el-button>
          <el-button
            v-if="node.childNodes.length === 0"
            type="text"
            size="mini"
            @click="remove(node, data)">
            删除
          </el-button>
        </span>
      </span>
    </el-tree>
    <el-dialog
      title="提示"
      :visible.sync="dialogVisible"
      width="30%">
      <el-form :model="category">
        <el-form-item label="分类名称">
          <el-input v-model="category.name" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
    <el-button @click="cancelAddCategory">取 消</el-button>
    <el-button type="primary" @click="addCategory">确 定</el-button>
  </span>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'category',
  data () {
    return {
      menus: [],
      expandedKey: [],
      dialogVisible: false,
      category: {name: '', parentCid: 0, catLevel: 0, showStatus: 1, sort: 0},
      defaultProps: {
        children: 'children',
        // label: 'name',
        label (data, node) {
          // console.log(`${data.catId} ${data.name}`)
          // console.log(data)
          return `${data.catId} ${data.name}`
        }
      }
    }
  },
  methods: {
    getMenus () {
      this.$http({
        url: this.$http.adornUrl('/product/category/list/tree'),
        method: 'get'
      }).then(({data}) => {
        // console.log(data.data)
        this.menus = data.data
      })
    },
    append (data) {
      // console.log(data)
      this.category.parentCid = data.catId
      this.category.catLevel = data.catLevel + 1
      this.dialogVisible = true
    },
    addCategory () {
      this.$http({
        url: this.$http.adornUrl('/product/category/save'),
        method: 'post',
        data: this.$http.adornData(this.category, false)
      }).then(({data}) => {
        this.$message({
          type: 'success',
          message: '菜单保存成功'
        })
        this.dialogVisible = false
        this.category.name = ''
        // 刷新菜单
        this.getMenus()
        // 自动展开到父节点
        this.expandedKey = [this.category.parentCid]
      })
    },
    cancelAddCategory () {
      this.dialogVisible = false
      this.category.name = ''
    },
    remove (node, data) {
      this.$confirm(`是否删除【${data.name}】菜单?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        let ids = [data.catId]
        this.$http({
          url: this.$http.adornUrl('/product/category/delete'),
          method: 'post',
          data: this.$http.adornData(ids, false)
        }).then(({data}) => {
          this.$message({
            type: 'success',
            message: '菜单删除成功'
          })
          // 刷新菜单
          this.getMenus()
          // 自动展开到父节点
          this.expandedKey = [node.parent.data.catId]
        })
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消删除'
        })
      })
    }
  },
  // 生命周期
  activated () {
    this.getMenus()
  }
}
</script>

<style scoped>
.custom-tree-node {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  padding-right: 8px;
}
</style>
```

### 5.6 修改分类

```vue
<!--suppress ALL -->
<template>
  <div>
    <el-tree :data="menus" :props="defaultProps" show-checkbox
             node-key="catId" :expand-on-click-node="false"
             :default-expanded-keys="expandedKey">
    <span class="custom-tree-node" slot-scope="{ node, data }">
        <span>{{ node.label }}</span>
        <span>
          <el-button
            v-if="node.level <= 2"
            type="text"
            size="mini"
            @click="append(data)">
            添加
          </el-button>
          <el-button
            type="text"
            size="mini"
            @click="edit(data)">
            修改
          </el-button>
          <el-button
            v-if="node.childNodes.length === 0"
            type="text"
            size="mini"
            @click="remove(node, data)">
            删除
          </el-button>
        </span>
      </span>
    </el-tree>
    <el-dialog
      :title="title"
      :visible.sync="dialogVisible"
      width="30%">
      <el-form :model="category">
        <el-form-item label="分类名称">
          <el-input v-model="category.name" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="图标">
          <el-input v-model="category.icon" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="计量单位">
          <el-input
            v-model="category.productUnit"
            autocomplete="off"
          ></el-input>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
    <el-button @click="this.dialogVisible = false">取 消</el-button>
    <el-button type="primary" @click="addCategory">确 定</el-button>
  </span>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'category',
  data () {
    return {
      title: '',
      dialogType: '',
      menus: [],
      expandedKey: [],
      dialogVisible: false,
      category: {name: '', parentCid: 0, catLevel: 0, showStatus: 1, sort: 0, icon: '', productUnit: '', catId: null},
      defaultProps: {
        children: 'children',
        // label: 'name',
        label (data, node) {
          // console.log(`${data.catId} ${data.name}`)
          // console.log(data)
          return `${data.catId} ${data.name}`
        }
      }
    }
  },
  methods: {
    getMenus () {
      this.$http({
        url: this.$http.adornUrl('/product/category/list/tree'),
        method: 'get'
      }).then(({data}) => {
        // console.log(data.data)
        this.menus = data.data
      })
    },
    append (data) {
      // console.log(data)
      this.dialog = 'add'
      this.title = '添加分类'
      this.category.parentCid = data.catId
      this.category.catLevel = data.catLevel + 1
      this.category.catId = null
      this.category.name = null
      this.category.icon = ''
      this.category.productUnit = ''
      this.category.sort = 0
      this.category.showStatus = 1
      this.dialogVisible = true
    },
    addCategory () {
      this.$http({
        url: this.$http.adornUrl('/product/category/save'),
        method: 'post',
        data: this.$http.adornData(this.category, false)
      }).then(({data}) => {
        this.$message({
          type: 'success',
          message: '菜单保存成功'
        })
        this.dialogVisible = false
        this.category.name = ''
        // 刷新菜单
        this.getMenus()
        // 自动展开到父节点
        this.expandedKey = [this.category.parentCid]
      })
    },
    edit (data) {
      this.dialogType = 'edit'
      this.title = '修改分类'
      // 发送请求获取节点最新的数据
      this.$http({
        url: this.$http.adornUrl(`/product/category/info/${data.catId}`),
        method: 'get'
      }).then(({data}) => {
        // 请求成功
        this.category.name = data.category.name
        this.category.catId = data.category.catId
        this.category.icon = data.category.icon
        this.category.productUnit = data.category.productUnit
        this.category.parentCid = data.category.parentCid
        this.dialogVisible = true
      })
    },
    // 修改三级分类数据
    editCategory () {
      var {catId, name, icon, productUnit} = this.category
      this.$http({
        url: this.$http.adornUrl('/product/category/update'),
        method: 'post',
        data: this.$http.adornData({catId, name, icon, productUnit}, false)
      })
        .then(({data}) => {
          this.$message({
            type: 'success',
            message: '菜单修改成功'
          })
          // 关闭对话框
          this.dialogVisible = false
          // 刷新出新的菜单
          this.getMenus()
          // 设置需要默认展开的菜单
          this.expandedKey = [this.category.parentCid]
        })
    },
    submitData () {
      if (this.dialogType === 'add') {
        this.addCategory()
      }
      if (this.dialogType === 'edit') {
        this.editCategory()
      }
    },
    remove (node, data) {
      this.$confirm(`是否删除【${data.name}】菜单?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        let ids = [data.catId]
        this.$http({
          url: this.$http.adornUrl('/product/category/delete'),
          method: 'post',
          data: this.$http.adornData(ids, false)
        }).then(({data}) => {
          this.$message({
            type: 'success',
            message: '菜单删除成功'
          })
          // 刷新菜单
          this.getMenus()
          // 自动展开到父节点
          this.expandedKey = [node.parent.data.catId]
        })
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消删除'
        })
      })
    }
  },
  // 生命周期
  activated () {
    this.getMenus()
  }
}
</script>

<style scoped>
.custom-tree-node {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  padding-right: 8px;
}
</style>
```

### 5.7 拖拽分类并保存

```vue
<template>
  <div>
    <el-switch v-model="draggable" active-text="开启拖拽" inactive-text="关闭拖拽"></el-switch>
    <el-button @click="batchSave" v-if="draggable">批量保存</el-button>
    <el-tree :data="menus" :props="defaultProps" show-checkbox
             node-key="catId" :expand-on-click-node="false"
             :default-expanded-keys="expandedKey"
             :draggable="draggable"
             :allow-drop="allowDrop"
             @node-drop="handleDrop">
    <span class="custom-tree-node" slot-scope="{ node, data }">
        <span>{{ node.label }}</span>
        <span>
          <el-button
            v-if="node.level <= 2"
            type="text"
            size="mini"
            @click="append(data)">
            添加
          </el-button>
          <el-button
            type="text"
            size="mini"
            @click="edit(data)">
            修改
          </el-button>
          <el-button
            v-if="node.childNodes.length === 0"
            type="text"
            size="mini"
            @click="remove(node, data)">
            删除
          </el-button>
        </span>
      </span>
    </el-tree>
    <el-dialog
      :title="title"
      :visible.sync="dialogVisible"
      width="30%">
      <el-form :model="category">
        <el-form-item label="分类名称">
          <el-input v-model="category.name" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="图标">
          <el-input v-model="category.icon" autocomplete="off"></el-input>
        </el-form-item>
        <el-form-item label="计量单位">
          <el-input v-model="category.productUnit" autocomplete="off"></el-input>
        </el-form-item>
      </el-form>
      <span slot="footer" class="dialog-footer">
    <el-button @click="dialogVisible = false">取 消</el-button>
    <el-button type="primary" @click="addCategory">确 定</el-button>
  </span>
    </el-dialog>
  </div>
</template>

<script>
export default {
  name: 'category',
  data () {
    return {
      pCid: [],
      draggable: false,
      updateNodes: [],
      maxLevel: 0,
      title: '',
      dialogType: '',
      menus: [],
      expandedKey: [],
      dialogVisible: false,
      category: {name: '', parentCid: 0, catLevel: 0, showStatus: 1, sort: 0, icon: '', productUnit: '', catId: null},
      defaultProps: {
        children: 'children',
        // label: 'name',
        label (data, node) {
          // console.log(`${data.catId} ${data.name}`)
          // console.log(data)
          return `${data.catId} ${data.name}`
        }
      }
    }
  },
  methods: {
    batchSave () {
      this.$http({
        url: this.$http.adornUrl('/product/category/update/sort'),
        method: 'post',
        data: this.$http.adornData(this.updateNodes, false)
      })
        .then(({data}) => {
          this.$message({
            type: 'success',
            message: '菜单顺序修改成功'
          })
          // 刷新出新的菜单
          this.getMenus()
          // 设置需要默认展开的菜单
          this.expandedKey = this.pCid
          this.updateNodes = []
          this.maxLevel = 0
          // this.pCid = 0;
        })
        .catch(() => {
        })
    },
    handleDrop (draggingNode, dropNode, dropType, ev) {
      console.log('handleDrop: ', draggingNode, dropNode, dropType)

      // 1 当前节点最新的父节点
      let pCid = 0
      let siblings = null
      if (dropType === 'before' || dropType === 'after') {
        pCid =
          dropNode.parent.data.catId === undefined
            ? 0
            : dropNode.parent.data.catId
        siblings = dropNode.parent.childNodes
      } else {
        pCid = dropNode.data.catId
        siblings = dropNode.childNodes
      }
      this.pCid.push(pCid)
      // 2 当前拖拽节点的最新顺序
      for (let i = 0; i < siblings.length; i++) {
        if (siblings[i].data.catId === draggingNode.data.catId) {
          // 如果遍历的是当前正在拖拽的节点
          let catLevel = draggingNode.level
          if (siblings[i].level !== draggingNode.level) {
            // 当前节点的层级发生变化
            catLevel = siblings[i].level
            // 修改他子节点的层级
            this.updateChildNodeLevel(siblings[i])
          }
          this.updateNodes.push({
            catId: siblings[i].data.catId,
            sort: i,
            parentCid: pCid,
            catLevel: catLevel
          })
        } else {
          this.updateNodes.push({catId: siblings[i].data.catId, sort: i})
        }
      }
      // 3 当前拖拽节点的最新层级
      console.log('updateNodes', this.updateNodes)
    },
    updateChildNodeLevel (node) {
      if (node.childNodes.length > 0) {
        for (let i = 0; i < node.childNodes.length; i++) {
          let cNode = node.childNodes[i].data
          this.updateNodes.push({
            catId: cNode.catId,
            catLevel: node.childNodes[i].level
          })
          this.updateChildNodeLevel(node.childNodes[i])
        }
      }
    },
    allowDrop (draggingNode, dropNode, type) {
      // 1 被拖动的当前节点以及所在的父节点总层数不能大于3

      // 1 被拖动的当前节点总层数
      console.log('allowDrop:', draggingNode, dropNode, type)

      this.countNodeLevel(draggingNode)

      // 当前正在拖动的节点+父节点所在的深度不大于3即可
      let deep = Math.abs(this.maxLevel - draggingNode.level) + 1
      console.log('深度:', deep)

      // this.maxLevel
      if (type === 'innner') {
        // console.log(
        //   `this.maxLevel: ${this.maxLevel}; draggingNode.data.catLevel:${draggingNode.data.catLevel};dropNode.level: ${dropNode.level}`
        // );
        return deep + dropNode.level <= 3
      } else {
        return deep + dropNode.parent.level <= 3
      }
    },
    countNodeLevel (node) {
      // 找到所有子节点，求出最大深度
      if (node.childNodes != null && node.childNodes.length > 0) {
        for (let i = 0; i < node.childNodes.length; i++) {
          if (node.childNodes[i].level > this.maxLevel) {
            this.maxLevel = node.childNodes[i].level
          }
          this.countNodeLevel(node.childNodes)
        }
      }
    },
    getMenus () {
      this.$http({
        url: this.$http.adornUrl('/product/category/list/tree'),
        method: 'get'
      }).then(({data}) => {
        // console.log(data.data)
        this.menus = data.data
      })
    },
    append (data) {
      // console.log(data)
      this.dialog = 'add'
      this.title = '添加分类'
      this.category.parentCid = data.catId
      this.category.catLevel = data.catLevel + 1
      this.category.catId = null
      this.category.name = null
      this.category.icon = ''
      this.category.productUnit = ''
      this.category.sort = 0
      this.category.showStatus = 1
      this.dialogVisible = true
    },
    addCategory () {
      this.$http({
        url: this.$http.adornUrl('/product/category/save'),
        method: 'post',
        data: this.$http.adornData(this.category, false)
      }).then(({data}) => {
        this.$message({
          type: 'success',
          message: '菜单保存成功'
        })
        this.dialogVisible = false
        this.category.name = ''
        // 刷新菜单
        this.getMenus()
        // 自动展开到父节点
        this.expandedKey = [this.category.parentCid]
      })
    },
    edit (data) {
      this.dialogType = 'edit'
      this.title = '修改分类'
      // 发送请求获取节点最新的数据
      this.$http({
        url: this.$http.adornUrl(`/product/category/info/${data.catId}`),
        method: 'get'
      }).then(({data}) => {
        // 请求成功
        this.category.name = data.category.name
        this.category.catId = data.category.catId
        this.category.icon = data.category.icon
        this.category.productUnit = data.category.productUnit
        this.category.parentCid = data.category.parentCid
        this.dialogVisible = true
      })
    },
    // 修改三级分类数据
    editCategory () {
      let {catId, name, icon, productUnit} = this.category
      this.$http({
        url: this.$http.adornUrl('/product/category/update'),
        method: 'post',
        data: this.$http.adornData({catId, name, icon, productUnit}, false)
      })
        .then(({data}) => {
          this.$message({
            type: 'success',
            message: '菜单修改成功'
          })
          // 关闭对话框
          this.dialogVisible = false
          // 刷新出新的菜单
          this.getMenus()
          // 设置需要默认展开的菜单
          this.expandedKey = [this.category.parentCid]
        })
    },
    submitData () {
      if (this.dialogType === 'add') {
        this.addCategory()
      }
      if (this.dialogType === 'edit') {
        this.editCategory()
      }
    },
    remove (node, data) {
      this.$confirm(`是否删除【${data.name}】菜单?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        let ids = [data.catId]
        this.$http({
          url: this.$http.adornUrl('/product/category/delete'),
          method: 'post',
          data: this.$http.adornData(ids, false)
        }).then(({data}) => {
          this.$message({
            type: 'success',
            message: '菜单删除成功'
          })
          // 刷新菜单
          this.getMenus()
          // 自动展开到父节点
          this.expandedKey = [node.parent.data.catId]
        })
      }).catch(() => {
        this.$message({
          type: 'info',
          message: '已取消删除'
        })
      })
    }
  },
  // 生命周期
  activated () {
    this.getMenus()
  }
}
</script>

<style scoped>
.custom-tree-node {
  flex: 1;
  display: flex;
  align-items: center;
  justify-content: space-between;
  font-size: 14px;
  padding-right: 8px;
}
</style>
```

在gulimall-product的CategoryController添加方法

```java
/**
 * 修改分类
 */
@RequestMapping("/update/sort")
public R update(@RequestBody CategoryEntity[] category){

    categoryService.updateBatchById(Arrays.asList(category));

    return R.ok();
}
```

## 6. 品牌管理

### 6.1 效果优化与快速显示开关

新增菜单

![image-20220414134746211](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220414134746211.png)

导入逆向生成的brand.vue和brand-add-or-update.vue

搜索权限判断，改为返回true

![image-20220414134912941](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220414134912941.png)

优化

```vue
<template>
  <div class="mod-config">
    <el-form :inline="true" :model="dataForm" @keyup.enter.native="getDataList()">
      <el-form-item>
        <el-input v-model="dataForm.key" placeholder="参数名" clearable></el-input>
      </el-form-item>
      <el-form-item>
        <el-button @click="getDataList()">查询</el-button>
        <el-button v-if="isAuth('product:brand:save')" type="primary" @click="addOrUpdateHandle()">新增</el-button>
        <el-button v-if="isAuth('product:brand:delete')" type="danger" @click="deleteHandle()"
                   :disabled="dataListSelections.length <= 0">批量删除
        </el-button>
      </el-form-item>
    </el-form>
    <el-table
      :data="dataList"
      border
      v-loading="dataListLoading"
      @selection-change="selectionChangeHandle"
      style="width: 100%;">
      <el-table-column
        type="selection"
        header-align="center"
        align="center"
        width="50">
      </el-table-column>
      <el-table-column
        prop="brandId"
        header-align="center"
        align="center"
        label="品牌id">
      </el-table-column>
      <el-table-column
        prop="name"
        header-align="center"
        align="center"
        label="品牌名">
      </el-table-column>
      <el-table-column
        prop="logo"
        header-align="center"
        align="center"
        label="品牌logo地址">
      </el-table-column>
      <el-table-column
        prop="descript"
        header-align="center"
        align="center"
        label="介绍">
      </el-table-column>
      <el-table-column
        prop="showStatus"
        header-align="center"
        align="center"
        label="显示状态">
        <template slot-scope="scope">
          <el-switch
            v-model="scope.row.showStatus"
            active-color="#13ce66"
            inactive-color="#ff4949"
            :active-value="1"
            :inactive-value="0"
            @change="updateBrandStatus(scope.row)"
          >
          </el-switch>
        </template>
      </el-table-column>
      <el-table-column
        prop="firstLetter"
        header-align="center"
        align="center"
        label="检索首字母">
      </el-table-column>
      <el-table-column
        prop="sort"
        header-align="center"
        align="center"
        label="排序">
      </el-table-column>
      <el-table-column
        fixed="right"
        header-align="center"
        align="center"
        width="150"
        label="操作">
        <template slot-scope="scope">
          <el-button type="text" size="small" @click="addOrUpdateHandle(scope.row.brandId)">修改</el-button>
          <el-button type="text" size="small" @click="deleteHandle(scope.row.brandId)">删除</el-button>
        </template>
      </el-table-column>
    </el-table>
    <el-pagination
      @size-change="sizeChangeHandle"
      @current-change="currentChangeHandle"
      :current-page="pageIndex"
      :page-sizes="[10, 20, 50, 100]"
      :page-size="pageSize"
      :total="totalPage"
      layout="total, sizes, prev, pager, next, jumper">
    </el-pagination>
    <!-- 弹窗, 新增 / 修改 -->
    <add-or-update v-if="addOrUpdateVisible" ref="addOrUpdate" @refreshDataList="getDataList"></add-or-update>
  </div>
</template>

<script>
import AddOrUpdate from './brand-add-or-update'

export default {
  data () {
    return {
      dataForm: {
        key: ''
      },
      dataList: [],
      pageIndex: 1,
      pageSize: 10,
      totalPage: 0,
      dataListLoading: false,
      dataListSelections: [],
      addOrUpdateVisible: false
    }
  },
  components: {
    AddOrUpdate
  },
  activated () {
    this.getDataList()
  },
  methods: {
    updateBrandStatus (data) {
      console.log('最新信息', data)
      let {brandId, showStatus} = data
      this.$http({
        url: this.$http.adornUrl('/product/brand/update'),
        method: 'post',
        data: this.$http.adornData({brandId, showStatus: showStatus}, false)
      }).then(({data}) => {
        this.$message({
          type: 'success',
          message: '状态更新成功'
        })
      })
    },
    // 获取数据列表
    getDataList () {
      this.dataListLoading = true
      this.$http({
        url: this.$http.adornUrl('/product/brand/list'),
        method: 'get',
        params: this.$http.adornParams({
          'page': this.pageIndex,
          'limit': this.pageSize,
          'key': this.dataForm.key
        })
      }).then(({data}) => {
        if (data && data.code === 0) {
          this.dataList = data.page.list
          this.totalPage = data.page.totalCount
        } else {
          this.dataList = []
          this.totalPage = 0
        }
        this.dataListLoading = false
      })
    },
    // 每页数
    sizeChangeHandle (val) {
      this.pageSize = val
      this.pageIndex = 1
      this.getDataList()
    },
    // 当前页
    currentChangeHandle (val) {
      this.pageIndex = val
      this.getDataList()
    },
    // 多选
    selectionChangeHandle (val) {
      this.dataListSelections = val
    },
    // 新增 / 修改
    addOrUpdateHandle (id) {
      this.addOrUpdateVisible = true
      this.$nextTick(() => {
        this.$refs.addOrUpdate.init(id)
      })
    },
    // 删除
    deleteHandle (id) {
      var ids = id ? [id] : this.dataListSelections.map(item => {
        return item.brandId
      })
      this.$confirm(`确定对[id=${ids.join(',')}]进行[${id ? '删除' : '批量删除'}]操作?`, '提示', {
        confirmButtonText: '确定',
        cancelButtonText: '取消',
        type: 'warning'
      }).then(() => {
        this.$http({
          url: this.$http.adornUrl('/product/brand/delete'),
          method: 'post',
          data: this.$http.adornData(ids, false)
        }).then(({data}) => {
          if (data && data.code === 0) {
            this.$message({
              message: '操作成功',
              type: 'success',
              duration: 1500,
              onClose: () => {
                this.getDataList()
              }
            })
          } else {
            this.$message.error(data.msg)
          }
        })
      })
    }
  }
}
</script>
```

### 6.2 添加上传 *

![image-20220414140514188](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220414140514188.png)

使用阿里云OSS，创建子用户，选择OpenApi，获取accessid和accesskey，配置oss权限

gulimall-product导入依赖

```xml
<dependency>
    <groupId>com.alibaba.cloud</groupId>
    <artifactId>spring-cloud-starter-alicloud-oss</artifactId>
    <version>2.2.0.RELEASE</version>
</dependency>
```

配置access-key，secret-key，endpoint

```yml
spring:
  datasource:
#    type: com.alibaba.druid.pool.DruidDataSource
    driverClassName: com.mysql.cj.jdbc.Driver
    url: jdbc:mysql://124.220.11.122:3306/gulimall_pms?useUnicode=true&characterEncoding=UTF-8&useSSL=false&serverTimezone=Asia/Shanghai
    username: root
    password: Ytc19980211..
  application:
    name: gulimall-product
  cloud:
    nacos:
      discovery:
        server-addr: 124.220.11.122:8848
    alicloud:
      access-key: LTAI5tBtgeWMi54KnHAKnjQw
      secret-key: cW4T8aChqVm6O2029gze2bZViqvoI7
      oss:
        endpoint: oss-cn-shanghai.aliyuncs.com
```

测试

```java
@Autowired
OSS ossClient;

@Test
void contextLoads() throws FileNotFoundException {
    // 填写本地文件的完整路径，例如D:\\localpath\\examplefile.txt。
    // 如果未指定本地路径，则默认从示例程序所属项目对应本地路径中上传文件流。
    String filePath= "C:\\Users\\YTC\\Pictures\\SavedPictures\\16e4f94af4aae922fc3b8fe9f37984b649e51650.jpg@240w_240h_1c_1s.png";

    try {
        InputStream inputStream = new FileInputStream(filePath);
        // 创建PutObject请求。
        ossClient.putObject("ytc-gulimall", "c.png", inputStream);
    } catch (OSSException oe) {
        System.out.println("Caught an OSSException, which means your request made it to OSS, "
                           + "but was rejected with an error response for some reason.");
        System.out.println("Error Message:" + oe.getErrorMessage());
        System.out.println("Error Code:" + oe.getErrorCode());
        System.out.println("Request ID:" + oe.getRequestId());
        System.out.println("Host ID:" + oe.getHostId());
    } catch (ClientException ce) {
        System.out.println("Caught an ClientException, which means the client encountered "
                           + "a serious internal problem while trying to communicate with OSS, "
                           + "such as not being able to access the network.");
        System.out.println("Error Message:" + ce.getMessage());
    } finally {
        if (ossClient != null) {
            ossClient.shutdown();
        }
    }
}
```

创建thirdparty模块

添加oss依赖

配置yml

```yml
spring:
  application:
    name: gulimall-third-party
  cloud:
    nacos:
      discovery:
        server-addr: 124.220.11.122:8848
    alicloud:
      access-key: LTAI5tBtgeWMi54KnHAKnjQw
      secret-key: cW4T8aChqVm6O2029gze2bZViqvoI7
      oss:
        endpoint: oss-cn-shanghai.aliyuncs.com
server:
  port: 11600
```

编写OssController

```java
@RestController
public class OssController {

    @Autowired
    OSS ossClient;
    @Value("${spring.cloud.alicloud.oss.endpoint}")
    String endpoint;
    @Value("${spring.cloud.alicloud.oss.bucket}")
    String bucket;
    @Value("${spring.cloud.alicloud.access-key}")
    String accessId;
    @Value("${spring.cloud.alicloud.secret-key}")
    String accessKey;

    @RequestMapping("/oss/policy")
    public R policy() {

        String host = "https://" + bucket + "." + endpoint; // host的格式为 bucketname.endpoint

        String format = new SimpleDateFormat("yyyy-MM-dd").format(new Date());
        String dir = format; // 用户上传文件时指定的前缀。

        Map<String, String> respMap = null;
        try {
            long expireTime = 30;
            long expireEndTime = System.currentTimeMillis() + expireTime * 1000;
            Date expiration = new Date(expireEndTime);
            PolicyConditions policyConds = new PolicyConditions();
            policyConds.addConditionItem(PolicyConditions.COND_CONTENT_LENGTH_RANGE, 0, 1048576000);
            policyConds.addConditionItem(MatchMode.StartWith, PolicyConditions.COND_KEY, dir);

            String postPolicy = ossClient.generatePostPolicy(expiration, policyConds);
            byte[] binaryData = postPolicy.getBytes("utf-8");
            String encodedPolicy = BinaryUtil.toBase64String(binaryData);
            String postSignature = ossClient.calculatePostSignature(postPolicy);

            respMap = new LinkedHashMap<String, String>();
            respMap.put("accessid", accessId);
            respMap.put("policy", encodedPolicy);
            respMap.put("signature", postSignature);
            respMap.put("dir", dir);
            respMap.put("host", host);
            respMap.put("expire", String.valueOf(expireEndTime / 1000));

        } catch (Exception e) {
            // Assert.fail(e.getMessage());
            System.out.println(e.getMessage());
        } finally {
            ossClient.shutdown();
        }
        return R.ok().put("data", respMap);
    }

}
```

添加网关配置

```yml
- id: third_party_route
  uri: lb://gulimall-third-party
  predicates:
    - Path=/api/thirdparty/**
  filters:
    - RewritePath=/api/(?<segment>.*),/$\{segment} # 重新路径
```

添加文件上传组件

修改目标地址

![image-20220418212806407](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220418212806407.png)

修改brand-add-or-update.vue

导入SingleUpload，注册，使用，将logo地址绑定到组建中

```vue
<el-form-item label="品牌logo地址" prop="logo">
  <!--      <el-input v-model="dataForm.logo" placeholder="品牌logo地址"></el-input>-->
  <single-upload v-model="dataForm.logo"></single-upload>
</el-form-item>
```

配置oss的bucket跨域

![image-20220418214343086](https://ytc-picgo.oss-cn-shanghai.aliyuncs.com//image-20220418214343086.png)







----























 





































